name: Full Stack CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.changes.outputs.frontend }}
      backend: ${{ steps.changes.outputs.backend }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check for changes
      uses: dorny/paths-filter@v3
      id: changes
      with:
        filters: |
          frontend:
            - 'client/**'
          backend:
            - 'server/**'

  backend-pipeline:
    needs: changes
    if: ${{ needs.changes.outputs.backend == 'true' }}
    uses: ./.github/workflows/backend-ci-cd.yml

  frontend-pipeline:
    needs: changes
    if: ${{ needs.changes.outputs.frontend == 'true' }}
    uses: ./.github/workflows/frontend-ci-cd.yml

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [backend-pipeline, frontend-pipeline]
    if: github.ref == 'refs/heads/main'

    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install backend dependencies
      run: cd server && npm ci

    - name: Install frontend dependencies
      run: cd client && npm ci

    - name: Start backend server
      run: |
        cd server
        MONGODB_URI=mongodb://localhost:27017/test npm start &
        sleep 10
      env:
        PORT: 5000

    - name: Run integration tests
      run: |
        echo "Running integration tests..."
        # Add your integration test commands here
        # npm run test:integration
        echo "Integration tests completed!"

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [backend-pipeline, frontend-pipeline, integration-test]
    if: always()

    steps:
    - name: Deployment Success
      if: ${{ needs.backend-pipeline.result == 'success' && needs.frontend-pipeline.result == 'success' }}
      run: echo "üéâ Deployment successful!"

    - name: Deployment Failed
      if: ${{ needs.backend-pipeline.result == 'failure' || needs.frontend-pipeline.result == 'failure' }}
      run: echo "‚ùå Deployment failed!"